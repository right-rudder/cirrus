---
import ImageComp from "./ImageComp.astro";
import { COMPANY_NAME, PHONE_NUMBER_HEADER } from "../data/consts";
import { FaPhoneSquareAlt } from "react-icons/fa";
import Socials from "./Socials.astro";
import { menu } from "../data/menus";

const { pathname, navBarBG = false } = Astro.props;
---

<nav
  id="navbar"
  class={`navbar w-full flex justify-center transition-all duration-500 ease-in-out p-4 ${navBarBG ? "force-navbar-bg" : ""}`}
>
  <div class="container-desktop-nav flex items-center justify-between gap-6 w-full lg:w-fit">
    <!-- Logo -->
    <a href="/" class="object-contain h-auto">
      <ImageComp
        class="logo-white w-64 lg:w-48 xl:w-72"
        src="/src/assets/cirrus-anniversary-logo-white.webp"
        alt={`${COMPANY_NAME} Logo`}
      />
    </a>

    <!-- Desktop Menu -->
    <ul class="nav flex gap-3 list-none">
      {
        menu.map((item, index) => (
          <li
            class={`menu-item group text-base xl:text-lg 2xl:text-xl relative transition-colors duration-300 ease-in-out ${item.children ? "has-children" : ""}`}
            data-index={index}
          >
            <a href={item.url} class="whitespace-nowrap">
              {item.label}
            </a>
            {item.children && (
              <ul class="sub-menu absolute top-full left-0 z-40 min-w-56 bg-white border border-white list-none py-2 rounded-sm invisible opacity-0 translate-y-1.5 pointer-events-none transition-all duration-300 ease-in-out shadow shadow-slate-900/30 group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto">
                {item.children.map((child) => (
                  <li>
                    <a
                      href={child.url}
                      class={
                        (child.url === pathname || child.url + "/" === pathname) && child.url !== "/"
                          ? "menu-link-hover"
                          : ""
                      }
                    >
                      <span>{child.label}</span>
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>

    <!-- Buttons -->
    <div class="buttons">
      <a href="/contact-us#contact-us-form" class="btn-lime text-base! xl:text-lg!"> Contact Us </a>
    </div>

    <!-- Mobile Hamburger -->
    <button id="mobile-toggle" class="hamburger" aria-label="Toggle menu">
      <svg
        class="hamburger-menu-bars"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="3" x2="21" y1="6" y2="6"></line>
        <line x1="3" x2="21" y1="12" y2="12"></line>
        <line x1="3" x2="21" y1="18" y2="18"></line>
      </svg>
      <svg
        class="hamburger-menu-x"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M18 6 6 18"></path>
        <path d="m6 6 12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="mobile-menu">
    <ul>
      {
        menu.map((item, index) => (
          <li class="mobile-item" data-index={index}>
            <a href={item.url}>{item.label}</a>
            {item.children && (
              <ul class="mobile-submenu">
                {item.children.map((child) => (
                  <li>
                    <a
                      href={child.url}
                      class={
                        (child.url === pathname || child.url + "/" === pathname) && child.url !== "/"
                          ? "menu-link-hover"
                          : ""
                      }
                    >
                      {child.label}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>

    <div class="mobile-buttons">
      <a href="/contact-us#contact-us-form" class="btn-lime text-lg!"> Contact Us </a>

      <div class="flex justify-center items-center gap-3">
        <Socials />
      </div>
      {
        PHONE_NUMBER_HEADER && (
          <div class="flex justify-center items-center gap-3">
            <a
              href={`tel:${PHONE_NUMBER_HEADER}`}
              aria-labelledby="Call Us Now"
              title="Call Us Now"
              class="flex gap-3 justify-center items-center tracking-widest text-lg font-bold duration-300 ease-in-out hover:text-lime-500"
              aria-label="Call telephone Link"
            >
              <FaPhoneSquareAlt className="text-2xl" />
              {PHONE_NUMBER_HEADER}
            </a>
          </div>
        )
      }
    </div>
  </div>
</nav>

<style>
  @import "tailwindcss";

  .navbar.scrolled,
  .navbar.force-navbar-bg {
    @apply bg-[hsl(220,43%,11%,0.6)] backdrop-blur-sm shadow-[0_4px_8px_rgba(0,0,0,0.05)];
  }

  .menu-item a {
    @apply font-medium uppercase transition-all duration-300 ease-in-out text-white;
  }

  .menu-item a:hover,
  .menu-item a:has(+ ul > li > a.menu-link-hover) {
    @apply text-lime-500;
  }

  .navbar.scrolled .nav > .menu-item > a,
  .navbar.force-navbar-bg .nav > .menu-item > a {
    @apply text-white;
  }

  .navbar.scrolled .nav > .menu-item > a:hover,
  .navbar.scrolled .nav > .menu-item > a.menu-link-hover,
  .navbar.scrolled .nav > .menu-item a:has(+ ul > li > a.menu-link-hover),
  .navbar.force-navbar-bg .nav > .menu-item > a:hover,
  .navbar.force-navbar-bg .nav > .menu-item > a.menu-link-hover,
  .navbar.force-navbar-bg .nav > .menu-item a:has(+ ul > li > a.menu-link-hover) {
    @apply text-lime-500;
  }

  /* Dropdown (desktop) */
  .sub-menu {
    transition:
      opacity 0.3s ease,
      transform 0.3s ease,
      visibility 0.3s step-end; /* hide clicks when closed */
  }

  /* Show on hover */
  .menu-item:hover .sub-menu {
    transition:
      opacity 0.3s ease,
      transform 0.3s ease,
      visibility 0.3s step-start; /* become clickable immediately */
  }

  /* Small invisible “bridge” to prevent hover loss between item and submenu */
  .menu-item::after {
    content: "";
    @apply absolute left-0 right-0 top-full h-2.5 bg-transparent;
  }

  /* Dropdown items */
  .sub-menu li a {
    @apply block py-2 px-4 whitespace-nowrap text-slate-600 transition-all duration-300 ease-in-out relative;
  }

  .sub-menu li a:hover,
  .sub-menu li a.menu-link-hover {
    @apply text-slate-950;
  }

  .sub-menu li a span {
    @apply block w-fit relative;
  }

  .sub-menu li a span::after {
    content: "";
    @apply absolute left-0 right-0 -bottom-1 bg-lime-500 rounded-full h-1 transition-all duration-300 ease-in-out max-w-0;
  }

  .sub-menu li a:hover span::after,
  .sub-menu li a.menu-link-hover span::after {
    @apply max-w-full;
  }

  .container-desktop-nav .hamburger .hamburger-menu-x,
  .container-desktop-nav.open .hamburger .hamburger-menu-bars {
    @apply hidden;
  }

  .container-desktop-nav.open .hamburger .hamburger-menu-x,
  .container-desktop-nav .hamburger .hamburger-menu-bars {
    @apply block;
  }

  .hamburger {
    @apply hidden flex-col gap-1 bg-none border-none cursor-pointer text-white;
  }

  /* Mobile sheet (base) */
  .mobile-menu {
    @apply absolute w-full h-screen top-full left-0 bg-slate-900 text-white px-4 max-h-0 overflow-hidden transition-all duration-500 ease-in-out;
  }
  .mobile-menu.open {
    @apply py-4 max-h-screen overflow-visible;
  }

  /* Mobile submenu animation (base) */
  .mobile-submenu {
    transition:
      max-height 0.5s ease,
      opacity 0.3s ease;
    @apply max-h-0 overflow-hidden opacity-0;
  }
  .mobile-submenu.open {
    @apply max-h-80 opacity-100;
  }

  /* ===== MOBILE-ONLY CHANGES BELOW ===== */
  @media (max-width: 1023px) {
    .navbar,
    .navbar.scrolled {
      @apply bg-slate-900 p-2;
    }

    .nav,
    .buttons {
      @apply hidden;
    }
    .hamburger {
      @apply flex;
    }

    /* Closed state: no vertical padding, zero height */
    .mobile-menu {
      @apply px-4;
    }

    /* Open state: add vertical padding + usable height */
    .mobile-menu.open {
      @apply pt-3 pb-3.5 max-h-[100vh-64px] overflow-auto;
    }

    /* Parent rows: larger tap targets */
    .mobile-item > a {
      @apply flex items-center justify-between py-3 px-1 font-semibold transition-colors duration-300 ease-in-out;
    }

    /* Submenu styling */
    .mobile-submenu {
      @apply border-l-2 border-white ml-2.5 pl-1.5;
    }
    a:has(+ .mobile-submenu.open),
    a:has(+ .mobile-submenu .menu-link-hover) {
      @apply text-lime-500;
    }
    .mobile-submenu li a {
      @apply block py-2.5 pr-3 pl-[18px] rounded-md transition-all duration-200 ease-in-out;
    }
    .mobile-submenu li a:hover,
    .mobile-submenu li a.menu-link-hover {
      @apply text-lime-500;
    }

    /* Sticky full-width CTA */
    .mobile-buttons {
      @apply bg-transparent pt-3 pb-3.5 border-t border-t-slate-900 flex flex-col gap-3;
    }
  }

  @media screen and (min-width: 1280px) {
    .nav {
      @apply gap-8;
    }
  }
</style>

<script type="module">
  const navbar = document.getElementById("navbar");
  const mobileToggle = document.getElementById("mobile-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuHeaderContainer = document.querySelector("#navbar > .container-desktop-nav");

  function updateNavbar() {
    if (
      ((window.scrollY > 40 || window.innerWidth <= 1023) && !navbar.classList.contains("scrolled")) ||
      navbar.classList.contains("force-navbar-bg")
    ) {
      navbar.classList.add("scrolled");

      return;
    }

    if (window.scrollY <= 40 && window.innerWidth > 1023 && navbar.classList.contains("scrolled")) {
      navbar.classList.remove("scrolled");
    }
  }

  let scrollDebounceTimer;
  let resizeDebounceTimer;

  window.addEventListener("scroll", () => {
    clearTimeout(scrollDebounceTimer);

    setTimeout(updateNavbar, 200);
  });

  window.addEventListener("resize", () => {
    clearTimeout(resizeDebounceTimer);

    setTimeout(updateNavbar, 200);
  });

  document.addEventListener("DOMContentLoaded", updateNavbar);

  // Mobile menu open/close
  mobileToggle?.addEventListener("click", () => {
    mobileMenu?.classList.toggle("open");
    menuHeaderContainer?.classList.toggle("open");
    document.body.classList.toggle("overflow-hidden");
  });

  // Mobile submenu toggles (tweak: mark link .open and animate height)
  const mobileItems = document.querySelectorAll(".mobile-item");
  mobileItems.forEach((item) => {
    const link = item.querySelector(":scope > a");
    const submenu = item.querySelector(".mobile-submenu");
    if (submenu && link) {
      link.addEventListener("click", (e) => {
        e.preventDefault();

        const isOpen = submenu.classList.contains("open");

        document.querySelectorAll(".mobile-submenu.open").forEach((openSubmenu) => {
          if (openSubmenu !== submenu) {
            openSubmenu.classList.remove("open");
            openSubmenu.style.maxHeight = "0px";
            openSubmenu.style.opacity = "0";

            const openLink = openSubmenu.parentElement.querySelector(":scope > a.open");
            if (openLink) openLink.classList.remove("open");
          }
        });

        submenu.classList.toggle("open", !isOpen);
        link.classList.toggle("open", !isOpen);

        if (!isOpen) {
          submenu.style.maxHeight = submenu.scrollHeight + "px";
          submenu.style.opacity = "1";
        } else {
          submenu.style.maxHeight = "0px";
          submenu.style.opacity = "0";
        }
      });
    }
  });

  document.querySelectorAll("#mobile-menu a").forEach((link) => {
    link.addEventListener("click", (e) => {
      const parentItem = link.closest(".mobile-item");
      const hasSubmenu = parentItem && parentItem.querySelector(".mobile-submenu");

      // If this link just toggles a submenu, do nothing here
      if (hasSubmenu && e.target.closest("a").nextElementSibling === hasSubmenu) return;

      // Close mobile menu if it's open
      if (mobileMenu.classList.contains("open")) {
        mobileMenu.classList.remove("open");
        menuHeaderContainer?.classList.remove("open");
        document.body.classList.remove("overflow-hidden");
      }

      // Smooth scroll to hash links on the same page
      const href = link.getAttribute("href");
      if (href && href.includes("#")) {
        const targetId = href.split("#")[1];
        const targetEl = document.getElementById(targetId);
        if (targetEl) {
          setTimeout(() => {
            targetEl.scrollIntoView({ behavior: "smooth" });
          }, 150);
        }
      }
    });
  });
</script>
